<?xml version="1.0" encoding="UTF-8"?>
<jmeterTestPlan version="1.2" properties="5.0" jmeter="5.6.3">
  <hashTree>
    <TestPlan guiclass="TestPlanGui" testclass="TestPlan"
      testname="Concurrent Import with Shared Name">
      <elementProp name="TestPlan.user_defined_variables" elementType="Arguments"
        guiclass="ArgumentsPanel" testclass="Arguments">
        <collectionProp name="Arguments.arguments">
          <elementProp name="BASE_URL" elementType="Argument">
            <stringProp name="Argument.name">BASE_URL</stringProp>
            <stringProp name="Argument.value">http://localhost:3000</stringProp>
          </elementProp>
          <elementProp name="SHARED_NAME" elementType="Argument">
            <stringProp name="Argument.name">SHARED_NAME</stringProp>
            <stringProp name="Argument.value">Shared_Human</stringProp>
          </elementProp>
        </collectionProp>
      </elementProp>
      <stringProp name="TestPlan.comments">Concurrent import test with shared human name</stringProp>
    </TestPlan>
    <hashTree>
      <ThreadGroup guiclass="ThreadGroupGui" testclass="ThreadGroup"
        testname="Parallel Imports" >
        <intProp name="ThreadGroup.num_threads">3</intProp>
        <intProp name="ThreadGroup.ramp_time">1</intProp>
        <longProp name="ThreadGroup.duration">0</longProp>
        <longProp name="ThreadGroup.delay">0</longProp>
        <boolProp name="ThreadGroup.same_user_on_next_iteration">true</boolProp>
        <stringProp name="ThreadGroup.on_sample_error">continue</stringProp>
        <elementProp name="ThreadGroup.main_controller" elementType="LoopController"
          guiclass="LoopControlPanel" testclass="LoopController">
          <stringProp name="LoopController.loops">1</stringProp>
          <boolProp name="LoopController.continue_forever">false</boolProp>
        </elementProp>
      </ThreadGroup>
      <hashTree>
        <!-- Prepare Temp Import File -->
        <JSR223PreProcessor guiclass="TestBeanGUI" testclass="JSR223PreProcessor"
          testname="Prepare Temp Import File">
          <stringProp name="scriptLanguage">groovy</stringProp>
          <stringProp name="script"><![CDATA[
import groovy.json.JsonOutput
import java.nio.file.Files
import java.nio.file.StandardOpenOption
import java.nio.charset.StandardCharsets

def sharedName = vars.get('SHARED_NAME')
def humans = []

for (int i=0; i<10; i++) {
    humans << [
        name: sharedName,
        coordinates: [x: Math.round(Math.random()*1000), y: Math.round(Math.random()*1000)],
        realHero: true,
        hasToothpick: null,
        car: i % 2 + 1,
        mood: "LONGING",
        impactSpeed: Math.round(Math.random()*300),
        soundtrackName: "Track_${i+1}",
        minutesOfWaiting: null,
        weaponType: "SHOTGUN"
    ]
}

def tmpFile = Files.createTempFile("jmeter-import-${ctx.getThreadNum()}-", ".json")
Files.write(tmpFile, JsonOutput.toJson(humans).getBytes(StandardCharsets.UTF_8), StandardOpenOption.WRITE)
vars.put("TMP_IMPORT_FILE", tmpFile.toString())
          ]]></stringProp>
        </JSR223PreProcessor>
        <hashTree/>
        <!-- POST Import -->
        <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy"
          testname="POST Import with Duplicates">
          <stringProp name="HTTPSampler.domain">localhost</stringProp>
          <stringProp name="HTTPSampler.port">3000</stringProp>
          <stringProp name="HTTPSampler.protocol">http</stringProp>
          <stringProp name="HTTPSampler.path">/imports</stringProp>
          <stringProp name="HTTPSampler.method">POST</stringProp>
          <boolProp name="HTTPSampler.follow_redirects">true</boolProp>
          <boolProp name="HTTPSampler.use_keepalive">true</boolProp>
          <elementProp name="HTTPsampler.Files" elementType="HTTPFileArgs">
            <collectionProp name="HTTPFileArgs.files">
              <elementProp name="" elementType="HTTPFileArg">
                <stringProp name="File.mimetype">application/json</stringProp>
                <stringProp name="File.path">${TMP_IMPORT_FILE}</stringProp>
                <stringProp name="File.paramname">file</stringProp>
              </elementProp>
            </collectionProp>
          </elementProp>
        </HTTPSamplerProxy>
        <hashTree/>
      </hashTree>
    </hashTree>
  </hashTree>
</jmeterTestPlan>
